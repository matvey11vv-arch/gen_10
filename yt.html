
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ–π –º–∞—Å—Å—ã</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 40px;
            width: 100%;
            max-width: 700px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 25px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            gap: 10px;
        }
        
        input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 18px;
            transition: all 0.3s ease;
            outline: none;
        }
        
        input:focus {
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        
        .input-help {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #6a11cb;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: help;
            z-index: 1;
        }
        
        .help-text {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .input-help:hover + .help-text {
            display: block;
        }
        
        button {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(106, 17, 203, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .result {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #6a11cb;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result.active {
            display: block;
        }
        
        .result h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .result p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .mass-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .mass-label {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .mass-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #6a11cb;
            line-height: 1;
        }
        
        .mass-unit {
            font-size: 1.2em;
            color: #777;
            margin-top: 5px;
        }
        
        .examples {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .examples h4 {
            color: #555;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .example-item {
            background: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95em;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
        }
        
        .example-item:hover {
            background: #6a11cb;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(106, 17, 203, 0.2);
        }
        
        .example-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .example-formula {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .error {
            color: #ff4757;
            margin-top: 10px;
            font-weight: 500;
            display: none;
            padding: 10px 15px;
            background: #ffeaea;
            border-radius: 8px;
            border-left: 3px solid #ff4757;
        }
        
        .error.active {
            display: block;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .details {
            margin-top: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }
        
        .details.active {
            max-height: 500px;
        }
        
        .details h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .elements-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .element-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #6a11cb;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .element-symbol {
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .element-count {
            color: #666;
            font-size: 0.9em;
        }
        
        .element-mass {
            font-weight: 600;
            color: #6a11cb;
        }
        
        .toggle-details {
            background: transparent;
            color: #6a11cb;
            border: 1px solid #6a11cb;
            padding: 10px 20px;
            margin-top: 15px;
            width: auto;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .toggle-details:hover {
            background: #6a11cb;
            color: white;
        }
        
        .history {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }
        
        .history.active {
            display: block;
        }
        
        .history h4 {
            color: #555;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .history-item:hover {
            background: #e9ecef;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .clear-history {
            background: transparent;
            color: #ff4757;
            border: 1px solid #ff4757;
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .clear-history:hover {
            background: #ff4757;
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px 20px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            input, button {
                padding: 14px;
                font-size: 16px;
            }
            
            .elements-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
            
            .examples-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .mass-value {
                font-size: 2em;
            }
        }
        
        @media (max-width: 480px) {
            .examples-grid {
                grid-template-columns: 1fr;
            }
            
            .input-wrapper {
                flex-direction: column;
            }
        }
        
        .formula-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ–π –º–∞—Å—Å—ã</h1>
        
        <div class="input-group">
            <label for="formula">–•–∏–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞:</label>
            <div class="input-wrapper">
                <input type="text" id="formula" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: H‚ÇÇO, C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ, NaCl..." autofocus>
                <div class="input-help">?</div>
                <div class="help-text">
                    <strong>–§–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞:</strong><br>
                    ‚Ä¢ –ó–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã –≤–∞–∂–Ω—ã: CO ‚â† Co<br>
                    ‚Ä¢ –¶–∏—Ñ—Ä—ã –æ–±–æ–∑–Ω–∞—á–∞—é—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ç–æ–º–æ–≤: H‚ÇÇO<br>
                    ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–æ–±–∫–∏ –¥–ª—è –≥—Ä—É–ø–ø: (NH‚ÇÑ)‚ÇÇSO‚ÇÑ<br>
                    ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–∏—Å–ª–∞: H‚ÇÇO‚ÇÅ.‚ÇÖ<br>
                    ‚Ä¢ –ü—É—Å—Ç—ã–µ –ø–æ–ª—è –æ–∑–Ω–∞—á–∞—é—Ç 1 –∞—Ç–æ–º: NaCl
                </div>
            </div>
            <div class="error" id="error"></div>
            <div class="formula-info" id="formula-info"></div>
        </div>
        
        <button id="calculate">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–æ–ª–µ–∫—É–ª—è—Ä–Ω—É—é –º–∞—Å—Å—É</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç...</p>
        </div>
        
        <div class="result" id="result">
            <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞</h3>
            <p>–•–∏–º–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞: <strong id="formula-display"></strong></p>
            
            <div class="mass-container">
                <div class="mass-label">–ú–æ–ª–µ–∫—É–ª—è—Ä–Ω–∞—è –º–∞—Å—Å–∞:</div>
                <div class="mass-value" id="mass">0.00</div>
                <div class="mass-unit">–≥—Ä–∞–º–º –Ω–∞ –º–æ–ª—å (–≥/–º–æ–ª—å)</div>
            </div>
            
            <button class="toggle-details" id="toggle-details">
                <span>üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞</span>
            </button>
            
            <div class="details" id="details">
                <h4>–°–æ—Å—Ç–∞–≤ –º–æ–ª–µ–∫—É–ª—ã:</h4>
                <div class="elements-list" id="elements-list"></div>
            </div>
        </div>
        
        <div class="history" id="history">
            <h4>
                <span>üìú –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤</span>
                <button class="clear-history" id="clear-history">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </h4>
            <div class="history-list" id="history-list"></div>
        </div>
        
        <div class="examples">
            <h4>üß™ –ü—Ä–∏–º–µ—Ä—ã —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª:</h4>
            <div class="examples-grid" id="examples-grid">
                <!-- –ü—Ä–∏–º–µ—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞—Ç–æ–º–Ω—ã—Ö –º–∞—Å—Å (–≥/–º–æ–ª—å) - IUPAC 2021
        const atomicMasses = {
            'H': 1.008, 'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81,
            'C': 12.011, 'N': 14.007, 'O': 15.999, 'F': 18.998, 'Ne': 20.180,
            'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.085, 'P': 30.974,
            'S': 32.06, 'Cl': 35.45, 'Ar': 39.95, 'K': 39.098, 'Ca': 40.078,
            'Sc': 44.956, 'Ti': 47.867, 'V': 50.942, 'Cr': 51.996, 'Mn': 54.938,
            'Fe': 55.845, 'Co': 58.933, 'Ni': 58.693, 'Cu': 63.546, 'Zn': 65.38,
            'Ga': 69.723, 'Ge': 72.630, 'As': 74.922, 'Se': 78.971, 'Br': 79.904,
            'Kr': 83.798, 'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224,
            'Nb': 92.906, 'Mo': 95.95, 'Tc': 98.0, 'Ru': 101.07, 'Rh': 102.91,
            'Pd': 106.42, 'Ag': 107.87, 'Cd': 112.41, 'In': 114.82, 'Sn': 118.71,
            'Sb': 121.76, 'Te': 127.60, 'I': 126.90, 'Xe': 131.29, 'Cs': 132.91,
            'Ba': 137.33, 'La': 138.91, 'Ce': 140.12, 'Pr': 140.91, 'Nd': 144.24,
            'Pm': 145.0, 'Sm': 150.36, 'Eu': 151.96, 'Gd': 157.25, 'Tb': 158.93,
            'Dy': 162.50, 'Ho': 164.93, 'Er': 167.26, 'Tm': 168.93, 'Yb': 173.05,
            'Lu': 174.97, 'Hf': 178.49, 'Ta': 180.95, 'W': 183.84, 'Re': 186.21,
            'Os': 190.23, 'Ir': 192.22, 'Pt': 195.08, 'Au': 196.97, 'Hg': 200.59,
            'Tl': 204.38, 'Pb': 207.2, 'Bi': 208.98, 'Po': 209.0, 'At': 210.0,
            'Rn': 222.0, 'Fr': 223.0, 'Ra': 226.0, 'Ac': 227.0, 'Th': 232.04,
            'Pa': 231.04, 'U': 238.03, 'Np': 237.0, 'Pu': 244.0, 'Am': 243.0
        };

        // –ü—Ä–∏–º–µ—Ä—ã —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª
        const examples = [
            {formula: 'H2O', name: '–í–æ–¥–∞'},
            {formula: 'CO2', name: '–£–≥–ª–µ–∫–∏—Å–ª—ã–π –≥–∞–∑'},
            {formula: 'CH4', name: '–ú–µ—Ç–∞–Ω'},
            {formula: 'C6H12O6', name: '–ì–ª—é–∫–æ–∑–∞'},
            {formula: 'NaCl', name: '–ü–æ–≤–∞—Ä–µ–Ω–Ω–∞—è —Å–æ–ª—å'},
            {formula: 'H2SO4', name: '–°–µ—Ä–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞'},
            {formula: 'CaCO3', name: '–ö–∞—Ä–±–æ–Ω–∞—Ç –∫–∞–ª—å—Ü–∏—è'},
            {formula: '(NH4)2SO4', name: '–°—É–ª—å—Ñ–∞—Ç –∞–º–º–æ–Ω–∏—è'},
            {formula: 'C2H5OH', name: '–≠—Ç–∞–Ω–æ–ª'},
            {formula: 'CH3COOH', name: '–£–∫—Å—É—Å–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞'},
            {formula: 'C12H22O11', name: '–°–∞—Ö–∞—Ä–æ–∑–∞'},
            {formula: 'Fe2O3', name: '–û–∫—Å–∏–¥ –∂–µ–ª–µ–∑–∞(III)'},
            {formula: 'Al2O3', name: '–û–∫—Å–∏–¥ –∞–ª—é–º–∏–Ω–∏—è'},
            {formula: 'NaOH', name: '–ì–∏–¥—Ä–æ–∫—Å–∏–¥ –Ω–∞—Ç—Ä–∏—è'},
            {formula: 'HCl', name: '–°–æ–ª—è–Ω–∞—è –∫–∏—Å–ª–æ—Ç–∞'},
            {formula: 'NH3', name: '–ê–º–º–∏–∞–∫'}
        ];

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ (‚ÇÄ‚ÇÅ‚ÇÇ‚ÇÉ‚ÇÑ‚ÇÖ‚ÇÜ‚Çá‚Çà‚Çâ) –≤ –æ–±—ã—á–Ω—ã–µ —á–∏—Å–ª–∞
        function normalizeFormula(formula) {
            const subscriptMap = {
                '‚ÇÄ': '0', '‚ÇÅ': '1', '‚ÇÇ': '2', '‚ÇÉ': '3', '‚ÇÑ': '4',
                '‚ÇÖ': '5', '‚ÇÜ': '6', '‚Çá': '7', '‚Çà': '8', '‚Çâ': '9',
                '‚Å∞': '0', '¬π': '1', '¬≤': '2', '¬≥': '3', '‚Å¥': '4',
                '‚Åµ': '5', '‚Å∂': '6', '‚Å∑': '7', '‚Å∏': '8', '‚Åπ': '9'
            };
            
            return formula.split('').map(char => subscriptMap[char] || char).join('');
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –æ–±—ã—á–Ω—ã—Ö —á–∏—Å–µ–ª –≤ –Ω–∏–∂–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã
        function formatSubscripts(formula) {
            const subscriptMap = {
                '0': '‚ÇÄ', '1': '‚ÇÅ', '2': '‚ÇÇ', '3': '‚ÇÉ', '4': '‚ÇÑ',
                '5': '‚ÇÖ', '6': '‚ÇÜ', '7': '‚Çá', '8': '‚Çà', '9': '‚Çâ'
            };
            
            return formula.replace(/(\d+(?:\.\d+)?)/g, (match) => {
                return match.split('').map(d => subscriptMap[d] || d).join('');
            });
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Ö–∏–º–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º—É–ª—ã (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
        function parseFormula(formula) {
            formula = normalizeFormula(formula);
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ–±–µ–ª—ã
            formula = formula.replace(/\s+/g, '');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            if (!formula) return null;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            if (!/^[A-Za-z0-9().\[\]]+$/.test(formula)) {
                return null;
            }
            
            const elements = {};
            const stack = [{}];
            let i = 0;
            
            while (i < formula.length) {
                const char = formula[i];
                
                // –û—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                if (char === '(' || char === '[') {
                    stack.push({});
                    i++;
                }
                // –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
                else if (char === ')' || char === ']') {
                    const group = stack.pop();
                    i++;
                    
                    // –ß—Ç–µ–Ω–∏–µ –º–Ω–æ–∂–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ —Å–∫–æ–±–∫–∏
                    let multiplier = '';
                    while (i < formula.length && /[\d.]/.test(formula[i])) {
                        multiplier += formula[i];
                        i++;
                    }
                    const mult = multiplier ? parseFloat(multiplier) : 1;
                    
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã –≤ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    const current = stack[stack.length - 1];
                    for (const [element, count] of Object.entries(group)) {
                        current[element] = (current[element] || 0) + count * mult;
                    }
                }
                // –≠–ª–µ–º–µ–Ω—Ç (–∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞)
                else if (/[A-Z]/.test(char)) {
                    let element = char;
                    i++;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ—á–Ω—É—é –±—É–∫–≤—É
                    if (i < formula.length && /[a-z]/.test(formula[i])) {
                        element += formula[i];
                        i++;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
                    if (!atomicMasses[element]) {
                        throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ö–∏–º–∏—á–µ—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç: ${element}`);
                    }
                    
                    // –ß—Ç–µ–Ω–∏–µ —á–∏—Å–ª–∞ –∞—Ç–æ–º–æ–≤
                    let countStr = '';
                    while (i < formula.length && /[\d.]/.test(formula[i])) {
                        countStr += formula[i];
                        i++;
                    }
                    const count = countStr ? parseFloat(countStr) : 1;
                    
                    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                    const current = stack[stack.length - 1];
                    current[element] = (current[element] || 0) + count;
                }
                // –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Å–∏–º–≤–æ–ª
                else {
                    return null;
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–ø–∞—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏
            if (stack.length !== 1) {
                return null;
            }
            
            return stack[0];
        }

        // –†–∞—Å—á–µ—Ç –º–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ–π –º–∞—Å—Å—ã
        function calculateMolecularMass(formula) {
            const elements = parseFormula(formula);
            
            if (!elements) {
                throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ö–∏–º–∏—á–µ—Å–∫–æ–π —Ñ–æ—Ä–º—É–ª—ã');
            }
            
            let totalMass = 0;
            const elementDetails = [];
            
            for (const [element, count] of Object.entries(elements)) {
                const atomicMass = atomicMasses[element];
                const elementMass = atomicMass * count;
                totalMass += elementMass;
                
                elementDetails.push({
                    symbol: element,
                    count: count,
                    atomicMass: atomicMass,
                    totalMass: elementMass,
                    percentage: 0 // –ë—É–¥–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–æ –ø–æ–∑–∂–µ
                });
            }
            
            // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è
            elementDetails.forEach(item => {
                item.percentage = (item.totalMass / totalMass * 100);
            });
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–∏–º–≤–æ–ª—É —ç–ª–µ–º–µ–Ω—Ç–∞
            elementDetails.sort((a, b) => a.symbol.localeCompare(b.symbol));
            
            return {
                totalMass: totalMass,
                elements: elementDetails,
                composition: elements
            };
        }

        // –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤
        class CalculationHistory {
            constructor() {
                this.key = 'molecular_mass_history';
                this.maxItems = 10;
                this.load();
            }
            
            load() {
                try {
                    const data = localStorage.getItem(this.key);
                    this.items = data ? JSON.parse(data) : [];
                } catch (e) {
                    this.items = [];
                }
            }
            
            save() {
                try {
                    localStorage.setItem(this.key, JSON.stringify(this.items));
                } catch (e) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é:', e);
                }
            }
            
            add(formula, result) {
                // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                this.items = this.items.filter(item => item.formula !== formula);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –Ω–∞—á–∞–ª–æ
                this.items.unshift({
                    formula: formula,
                    mass: result.totalMass.toFixed(4),
                    timestamp: new Date().toISOString(),
                    date: new Date().toLocaleString('ru-RU')
                });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
                if (this.items.length > this.maxItems) {
                    this.items = this.items.slice(0, this.maxItems);
                }
                
                this.save();
            }
            
            clear() {
                this.items = [];
                this.save();
            }
            
            getAll() {
                return this.items;
            }
        }

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const formulaInput = document.getElementById('formula');
        const calculateBtn = document.getElementById('calculate');
        const resultDiv = document.getElementById('result');
        const formulaDisplay = document.getElementById('formula-display');
        const massDisplay = document.getElementById('mass');
        const errorDisplay = document.getElementById('error');
        const detailsDiv = document.getElementById('details');
        const elementsList = document.getElementById('elements-list');
        const toggleDetailsBtn = document.getElementById('toggle-details');
        const loadingDiv = document.getElementById('loading');
        const historyDiv = document.getElementById('history');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history');
        const formulaInfo = document.getElementById('formula-info');
        const examplesGrid = document.getElementById('examples-grid');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
        const history = new CalculationHistory();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤
        function initExamples() {
            examples.forEach(example => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'example-item';
                exampleDiv.innerHTML = `
                    <div class="example-name">${example.name}</div>
                    <div class="example-formula">${formatSubscripts(example.formula)}</div>
                `;
                exampleDiv.addEventListener('click', () => {
                    setExample(example.formula);
                });
                examplesGrid.appendChild(exampleDiv);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        function displayHistory() {
            const items = history.getAll();
            
            if (items.length === 0) {
                historyDiv.classList.remove('active');
                return;
            }
            
            historyDiv.classList.add('active');
            historyList.innerHTML = '';
            
            items.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>
                        <strong>${formatSubscripts(item.formula)}</strong>
                        <div style="font-size: 0.8em; color: #666;">${item.date}</div>
                    </div>
                    <div style="font-weight: bold; color: #6a11cb;">${item.mass} –≥/–º–æ–ª—å</div>
                `;
                
                historyItem.addEventListener('click', () => {
                    setExample(item.formula);
                });
                
                historyList.appendChild(historyItem);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Ä–∞—Å—á–µ—Ç–∞
        calculateBtn.addEventListener('click', async () => {
            const formula = formulaInput.value.trim();
            
            // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            resultDiv.classList.remove('active');
            errorDisplay.classList.remove('active');
            detailsDiv.classList.remove('active');
            toggleDetailsBtn.querySelector('span').textContent = 'üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞';
            
            if (!formula) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ö–∏–º–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É–ª—É');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            loadingDiv.classList.add('active');
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            await new Promise(resolve => setTimeout(resolve, 100));
            
            try {
                const result = calculateMolecularMass(formula);
                const formattedFormula = formatSubscripts(formula);
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                formulaDisplay.textContent = formattedFormula;
                massDisplay.textContent = result.totalMass.toFixed(4);
                resultDiv.classList.add('active');
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Å–æ—Å—Ç–∞–≤–∞
                displayElementDetails(result.elements);
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                history.add(formula, result);
                displayHistory();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è
                massDisplay.style.transform = 'scale(0.9)';
                setTimeout(() => {
                    massDisplay.style.transform = 'scale(1)';
                }, 150);
                
            } catch (error) {
                showError(error.message);
            } finally {
                loadingDiv.classList.remove('active');
            }
        });

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π —Å–æ—Å—Ç–∞–≤–∞ –º–æ–ª–µ–∫—É–ª—ã
        function displayElementDetails(elements) {
            elementsList.innerHTML = '';
            
            elements.forEach(element => {
                const elementDiv = document.createElement('div');
                elementDiv.className = 'element-item';
                elementDiv.innerHTML = `
                    <div>
                        <span class="element-symbol">${element.symbol}</span>
                        <span class="element-count"> √ó ${element.count}</span>
                    </div>
                    <div style="text-align: right;">
                        <div class="element-mass">${element.totalMass.toFixed(2)} –≥/–º–æ–ª—å</div>
                        <div style="font-size: 0.85em; color: #666;">${element.percentage.toFixed(2)}%</div>
                    </div>
                `;
                elementsList.appendChild(elementDiv);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        formulaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                calculateBtn.click();
            }
        });

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–∏ –≤–≤–æ–¥–µ
        formulaInput.addEventListener('input', () => {
            const formula = formulaInput.value.trim();
            
            errorDisplay.classList.remove('active');
            formulaInfo.textContent = '';
            
            if (formula) {
                try {
                    // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                    const normalized = normalizeFormula(formula);
                    if (!/^[A-Z][a-z]?$/.test(normalized[0])) {
                        throw new Error('–§–æ—Ä–º—É–ª–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã —ç–ª–µ–º–µ–Ω—Ç–∞');
                    }
                    
                    // –ü–æ–¥—Å—á–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                    const tempResult = parseFormula(formula);
                    if (tempResult) {
                        const elementCount = Object.keys(tempResult).length;
                        formulaInfo.textContent = `–°–æ–¥–µ—Ä–∂–∏—Ç ${elementCount} —ç–ª–µ–º–µ–Ω—Ç${elementCount === 1 ? '' : (elementCount > 4 ? '–æ–≤' : '–∞')}`;
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ
                }
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Ä–∞—Å—á–µ—Ç–∞
        toggleDetailsBtn.addEventListener('click', () => {
            detailsDiv.classList.toggle('active');
            const span = toggleDetailsBtn.querySelector('span');
            span.textContent = detailsDiv.classList.contains('active') 
                ? 'üìã –°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞' 
                : 'üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—á–µ—Ç–∞';
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
        function showError(message) {
            errorDisplay.textContent = message;
            errorDisplay.classList.add('active');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
            formulaInput.style.borderColor = '#ff4757';
            formulaInput.style.boxShadow = '0 0 0 3px rgba(255, 71, 87, 0.1)';
            
            setTimeout(() => {
                if (errorDisplay.classList.contains('active')) {
                    formulaInput.style.borderColor = '';
                    formulaInput.style.boxShadow = '';
                }
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–º–µ—Ä–∞
        function setExample(formula) {
            formulaInput.value = formula;
            formulaInput.focus();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ä–º—É–ª–µ
            formulaInput.dispatchEvent(new Event('input'));
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
            setTimeout(() => {
                calculateBtn.click();
            }, 500);
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        clearHistoryBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —Ä–∞—Å—á–µ—Ç–æ–≤?')) {
                history.clear();
                displayHistory();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', () => {
            initExamples();
            displayHistory();
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            formulaInput.focus();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            const lastCalculation = history.getAll()[0];
            if (lastCalculation) {
                formulaInput.value = lastCalculation.formula;
                formulaInput.dispatchEvent(new Event('input'));
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
            console.log('–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–æ–ª–µ–∫—É–ª—è—Ä–Ω–æ–π –º–∞—Å—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–æ–ª–µ–µ 90 —Ö–∏–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.');
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            const formula = formulaInput.value.trim();
            if (formula) {
                try {
                    localStorage.setItem('last_formula', formula);
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ localStorage
                }
            }
        });
    </script>
</body>
</html>
```





